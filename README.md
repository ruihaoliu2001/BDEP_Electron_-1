# Slow Electron Velocity Imaging
2021 Physics Data Course Atomic and Molecular Physics Homework

提示：本题中有一些 GIF 动画无法嵌入 PDF，可以在网页或者仓库中查看。

## 物理背景
精细测量原子分子与离子的电子能级与电离能是一项重要且具有难度的任务。一种常见的做法是，使用激光激发位于某一能级的体系，使之释放电子。已知激光光子的能量为 $E = h\nu$，通过精确测量电子的动能 $E_k$ 来得知体系的束缚能（Binding Energy）$E_B = E - E_k$，这样的方法成为光电子能谱法（PES，Photonelectron/Photoemission Spectroscopy）。PES 在实验凝聚态与原子分子物理中有着广泛的应用。

冷原子/分子/离子团簇，经过瞬时激光照射后，会向各个方向发射大量电子。精确测量电子的动能就可以知道该能级的电离能 $E_B$。对于某一固定的电离能与激光波长，电子出射的动能固定，其动量空间是约束在一球面上：$p_x^2 + y_y^2 + p_z^2 = 2 m E_k$。所谓 SEVI，就是指对电子动量相空间进行“成像”，找到这个球面，进而测得 $E_k$。实际上，由于体系可能存在多个束缚能，因此 $E_k$ 往往是多个分立的值，动量空间为多个球面。

如何将动量空间转化为可测量的实空间？可以让电子从团簇中自由扩散。以电子电离为时间 0 点，假设电子之间没有相互作用，则在 $t$ 时刻，电子位置为 $\vec{r}=\vec{v}t$，电子将扩散成半径 $r=vt$ 的球面，且电子相对与球心的角分布正是电子动量的角分布。因此，如同烟花，通过让电子匀速扩散，即可将速度场 $\vec{v}$ 转化为电子的空间位置场 $\vec{r}$。

![alt text](Figures/CMFrame.gif)

*图1. $\vec{r}=\vec{v}t$，蓝色点为被电离的光电子*

为了测量 $\vec{r}$，实验学家制作了一段真空漂移管，通过电场能够让电离出来的电子在 $y$
方向整体获得一个速度，进而让电子团以一定速度漂移来固定时间 $t$，如图2。

![alt text](Figures/MVFrame.gif)

*图2. 实验室坐标系，红色平面为单电子探测器*

最终的图像为，原子团簇向四周发射电子；受成像电场作用，电子集体向 y 方向运动，经过时间 $t$ 的漂移后抵达探测平面；同时电子相对于质心系匀速膨胀，形成一个球面。

![alt text](Figures/apparatus.png)

*图4. 完整的仪器。我们关注从激光脱附（电离）到成像阶段*

# 第一阶段大作业
抵达探测平面后，电子较为稀疏。微通道板（Microchannel Plate, MCP）会将每个电子放大为大量电子，最终轰击荧光屏形成亮斑。亮斑由 CCD 相机拍照记录。

实验者试图获得的 $\vec{v}$ 是一个分布，统计量越高效果越好，但每一次激光照射只能激发为数不多的电子，因此，在实际中，各个电子的真实速度是对 $\vec{v}$ 的随机采样，荧光屏上的斑点也数目有限，一次实验要采集 50000 张照片，才可以获得较好的成像。

另外，由于激光被调制为 $z$ 轴的线偏振光，因此 $\vec{v}$ 关于 z 轴对称，空间可由柱坐标 $(r,z)$ 表示（关于 $\theta$ 对称）。简单起见，我们认为漂移时间 $t=1$，即 $\vec{v} = \vec{r}$。

你的任务是：模拟电子从离子团簇出射至探测器读出信号的过程。
输入：电子速度分布 $\vec{v}$。
输出：对于每一个分布，进行 50000 次实验。每次实验首先输出电子速度分布 $\vec{v}$ 的采样，然后生成 1 张 CCD 相机输出的照片，像素是 $2048 \times 2048$。

你需要对以下几种分布进行 $\vec{r}$ 的随机采样：
 1. 球坐标下，$\theta$ ~ $U(0,\pi)$，$\phi$ ~ $U(0,2\pi)$，$|\vec{r}|=R_0$，光电子数目固定，NPE=100
 2. 球坐标下，$\theta$ ~ $U(0,\pi)$，$\phi$ ~ $U(0,2\pi)$，$|\vec{r}|$ ~ $U(R_0,R_0 +\Delta R)$ 光电子数目服从高斯分布：NPE ~ $N(100,10)$，但 NPE 一定为整数且 NPE > 0
 3. 柱坐标下，$z$ ~ $U(0,R_0)$，$\phi$ ~ $U(0,2\pi)$，$|\vec{r}|$ ~ $U(R_0,R_0 +\Delta R)$，光电子数目服从泊松分布：NPE ~ $\pi(100)$。
 4. 球坐标下，$\cos^3\theta$ ~ $U(-1,1)$，$\phi$ ~ $U(0,2\pi)$，$|\vec{r}|$ ~ $U(R_0,R_0 +\Delta R)$，光电子数目服从泊松分布：NPE ~ $\pi(100)$。

## 数据格式

你需要自己定义一个数据格式，满足如下要求：

 1. 将每个分布存储在一个**启用压缩的** HDF5 文件中。
 2. 在 HDF5 文件中，你需要包含若干表格（若干是指，不多于 10 个），能够完备描述任务要求的输出信息。
 3. 所谓完备信息是指这些：每次实验产生的光电子数目是多少，每次实验电离出的光电子的速度矢量（用与其等效的 $\vec{r}$ 表示），以及每次实验 CCD 拍摄的图片（不同难度等级有不同定义，见下文）。
 4. 尽量少存储冗余信息。

## Makefile

本次作业提供了 `Makefile`，最终助教也将使用 `Makefile` 进行测试。需要注意，你在编写所有程序文件时，都应该使用 `make` 给程序传入的参数（来自 `sys.argv`），而非硬编码下面提到的文件名；否则，你可能无法通过测试。

在本目录中运行 `make -n` 即可看到实际运行的命令，这或许能帮助你开发。

## 基础内容 60'

在此难度级别下，CCD 图像的定义是，每个像素点上接收到的电子数目。具体要求：

1. 编写一个程序 `sevi_simulate.py` 来完成模拟，其接受两个参数，分别是分布编号（见上）、输出的 HDF5 文件名。你无需考虑任何复杂的物理过程与实验中的细节。你可以将微通道板与 CCD 组成的探测平面视作像素化的计数器，每一个像素能统计落入该像素的电子数目。编写完成后，运行 `make` 可以生成 `VelocityImage.%d.h5`，其中 `%d` 从 1 到 4，对应上面的四种分布。
2. 编写一个程序 `read_sim_data.py` ，接受 HDF5 文件名、实验编号、输出文件名作为命令行参数，将某次模拟绘制为 PNG 格式的图片，并向标准输出打印本次实验所产生的光电子数。你需要为图片加上必要的文字（如 title，坐标轴等），并在输出一些必要的提示信息，让运行程序的助教看得懂图片是什么意思、看得懂命令行输出的东西是什么意思。此部分无需对所有实验全部运行，助教将会挑选进行抽查。

正确完成基础内容，可以获得 $60\%$ 的分数。

注意：考虑到体积因素，**不允许**将生成的任何数据文件提交到仓库中。如果你认为程序运行时间可能较长，可以在报告中提供预先生成的结果文件的下载方式（如清华云盘地址）。也建议你将一些有代表性的结果图插入到实验报告中，以便助教批阅。

## 提高内容（至多 30'）

你需要考虑一些实验细节或者较为复杂的物理过程。例如：

### 激光方向偏角与倾斜的探测平面

激光偏振方向不再完美指向 $+z$，而是指向 $(\theta_l,\phi_l)$，$\theta_l\ll 1$


探测法方向不再完美指向 $-y$，而是指向 $(\frac{\pi}{2} + \theta_d,\phi_d - \frac{\pi}{2})$，$|\theta_d|, |\phi_d| \ll 1$

正确考虑这两个问题将分别为你加 $5\%$ 的分数。根据宁老师的指导，这些倾角在实际探测中影响非常有限，所以推荐大家可以先去完成后面的提高任务；不过如果你能分别用理论计算与程序模拟得出倾斜对于测量带来的影响很小的结论，可以为你的实验报告增光添彩。

### 亮斑的形状

你需要考虑更真实的拍摄过程。

#### Level 1:

无论如何，电子最终导致荧光屏上产生一个高斯圆形亮斑：设电子击中的位置位于荧光屏的 $(x_0,y_0)$，则电子将在屏幕上产生 $I_0(x,y)=I(x-x_0,y-y_0)=A\exp [-\frac{1}{2}\frac{(x-x_0)^2+(y-y_0)^2}{\sigma^2}]$ 的荧光光强，其中 $A=100$，$\sigma=0.001$。当两个光子的光斑有所重叠时，$I_{1,2}(x,y)$ 线性叠加：$I_{1,2}(x,y)=I_1(x,y)+I_2(x,y)=I(x-x_1,y-y_1)+I(x-x_2,y-y_2)$。

由于最后 CCD 相机的输出也要保存为像素化的数据，你需要对连续的像 $I(x,y)$ 进行离散化处理。CCD 视野内的荧光屏是一个 $[-1,1] \otimes [-1,1]$ 的矩形，CCD 像素 2048x2048，每个像素最终输出的强度大小是该像素内荧光光强 $I$ 的均值。

你还需要考虑 CCD 的白噪声：每个像素上会产生高斯噪声，分布为 $N(0,2)$。

CCD 的输出是一个整数；CCD 的饱和强度为 255，意味着超过 255 的输出都会被归结为 255；最低输出是 0，任何低于 0 的数值会被归 0。

除此之外，你需要考虑到电子不被探测到的可能性：对于单个电子，有 10% 的概率根本不会被探测到。你需要把电子是否被探测到这一部分中间信息加入你的数据结构，并且在 `read_sim_data.py` 打印有多少光电子被探测到了。

完成该部分将获得 $5\%$ 的分数。

#### Level 2:

Level 2 与 level 1 不兼容——你不能同时完成他们。Level 2 是 level 1 的升级版。如果你都完成了他们，评分时默认你完成了 Level 2，不过如果你的代码历史展现出了循序渐进，从易到难的研发过程，我们会在较为主观的版本控制部分（比如评价 commit message 书写等）为你加分。

请先阅读 level 1 的说明，以便更好理解 level 2 的描述。

现在，亮斑不再是一个圆形高斯斑点，强度与宽度也不再固定。$I_0(x,y)=I(x-x_0,y-y_0)=A\exp [-\frac{1}{2}\frac{(x-x_0)^2+(y-y_0)^2+2\rho (x-x_0)(y-y_0)}{\sigma^2}]$，$A$，$\sigma$, $\rho$ 都是满足（可能带截断的）高斯分布的随机变量：$A$ ~ $N(100,10)$ 且 $A>0$；$\sigma$ ~ $N(10^{-3},10^{-4})$ 且 $\sigma$ > 0; $\rho$ ~ $N(0,1)$。

与 level 1 类似，你也需要考虑白噪声，以及光电子不被探测的概率并在数据文件中标记；此外，针对**被探测**到的电子，你需要记录他们产生光斑的 $A$，$\sigma$, $\rho$，且在 `read_sim_data.py` 输出光电子个数、被探测到光电子个数之后打印被探测到电子的这三个变量。

完成该部分将获得 $10\%$ 的分数。

#### Level 3:

你需要考虑更复杂的电子探测模型。实际上，MCP 有两层，一层 MCP 类似蜂窝煤，有很多孔洞（微通道），电子进入这些孔洞后会在孔壁上撞击、倍增（无法进入孔洞的电子就不会被探测到，这也是为什么存在探测效率 90%），从微通道末端出射大量电子。出射的电子具备一定的角分布：$\cos^3\theta$ ~ $U(0,0.996)$，$\phi$ ~ $U(0,2\pi)$，一层 MCP 将一个电子放大为 N 个电子，N ~ $\pi(1000)$。

从第一层 MCP 出射后，大量电子会在两层 MCP 之间的间隙飞行，间隙距离为 $d_1=10^{-5}$，飞行后电子入射第二层 MCP，同样有 10% 的电子损失，以及 N ~ $\pi(1000)$ 的放大倍数，以及相同的出射角度分布。最终，从第二层 MCP 出射后，距离荧光屏还有 $d_2=10^{-3}$ 的飞行距离，最终 CCD 每个像素数值，是落入该像素内的电子数目。

与 level 1 一样，输出依然会在 255 饱和，且具有白噪声。不过，由于中间变量较多，记录数据时只需比 level 1 所要求的多以下几个变量：

 1. 对于每个被探测到的电子，最终倍增的光电子数 $A$
 2. 对于每个被探测到的电子，所处斑点的位置均值 $(\bar{x},\bar{y})$
 3. 对于每个被探测到的电子，所处斑点的展宽 $\sigma$ = $\sqrt{\overline{(x-\bar{x})^2+(y-\bar{y})^2}}$

 并按要求在 `read_sim_data.py` 打印这三个变量。

 完成该部分将获得 $20\%$ 的分数。

## 开放问题
你也可以考虑一些尚未得到解决或考察的前沿问题。例如：

### 电子-电子相互作用建模

在图1.中，我们认为电子与电子在扩散过程似乎互不干扰的匀速直线运动，但事实是否如此？目前的实验表明，电子间相互作用可以忽略，但你能否通过在本次作业的模拟中加入电子电子相互作用，并合理调整参数，来阐释这一现象？

### 微通道板对于电子放大过程的建模

提高部分的 level 1 ~ 3 给出了不同精细程度 MCP 放大电子的模型，但实际情况可能更加复杂。电子从 MCP 末端出射的角分布并不是 $\cos^3\theta$ ~ $U(0,0.996)$，而与其内部结构有关；电子飞行至第二块 MCP 时，并不只是只有“90% 进入”“10% 消失”两种情形，而是还有可能被反射，跳跃至第二块 MCP 更远的微通道入口。你需要调研 MCP 的性质，给出自己认为合理的 MCP 模型并生成响应的图像。由于你的模型可能与提高部分的模型不一样，所以如果你想两个任务都完成，就需要分别写两部分功能相似的代码，那么如何组织你的仓库与代码结构也是需要思考的。

## 其他说明

基础要求是所有拓展部分的必要条件，只有完成基础要求才能完成提高与开放问题。

提高板块之间可以互相兼容，比如你可以既考虑倾斜的激光，又考虑 level 2 的 亮斑形状模型。由于提高任务可选并且可以组合，因此本大作业的评分细则可能与另外两个大作业有所不同。

所以，最终的评分规则是：必须要完成基础部分，才可以获得  $60\%$；完成提高部分的“激光方向偏角与倾斜的探测平面”，可以最高获得  $10\%$；完成“亮斑的形状”可以最高获得  $20\%$；如果你完成了两个提高任务，那么最多可以获得  $30\%$。无论完成了多少任务（除了开放问题，这部分将一事一议），最终功能部分的得分最高为 90 分。

由于助教也不是这个专业的，所以题目里大部分参数都是瞎设的，因此你如果觉得某些参数不合理，请在实验报告中指出，并在代码的注释中写明该参数由自己指定。

## 非功能要求（20'）

你需要遵守基本礼仪，例如遵守学术规范、按要求使用版本控制。如果你使用了第三方的软件，特别是非自由软件，请务必熟悉其条款。如果第三方代码规定未经授权不得使用，那么使用时请取得授权。

此部分详见大作业公告，共占20分。

